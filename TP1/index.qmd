---
title: "TP1 - Savoir faire des cartes interactives avec Quarto et `bertin`"
format: 
  html:
    theme: custom.scss
    code-tools: true
    toc: false
    code-fold: false
    code-summary: "Show the code"
editor: visual
execute:
  echo: true
---

**L'objectif de ce TP est d'apprendre √† cr√©er des cartes interactives avec Quarto et la biblioth√®que JavaScript `bertin`.**

![](img/banner.png)

**Responsables p√©dagogiques**

Manhamady OUEDRAOGO (Burkina Faso) & Nicolas LAMBERT (France)

**Ont particip√© √† l'√©laboration de ce module**

Claude GRASLAND (France), Souleymane Sidi TRAORE (Mali), Malika MADELIN (France), S√©bastien REY-COYREHOURCQ (France), Vakaramoko BAMBA (C√¥te d'Ivoire), Hugues PECOUT (France), Yentougle MOUTORE (Togo), B√©n√©dicte GARNIER (France), C√¥omlan Charles HOUNTON (B√©nin), Pauline GLUSKI (France).

# 1. D√©marrer avec Quarto

## 1.1 Environnement logiciel.

Ce TP s'effectue dans le logiciel RStudio. Pour l'installer, vous pouvez vous rendre sur [cette page](https://posit.co/download/rstudio-desktop). Puis, vous devez installer [Quarto](https://quarto.org/docs/get-started/).

![](img/quartoinstall.png)

## 1.2 Cr√©er un document Quarto

-   Ouvrir le logiciel RStudio
-   cr√©er un document Quarto (file \> New File \> Quarto Document)

![](img/create.png)

-   cliquer sur "Create Empty Document".
-   Mettez votre nom
-   Sauvegardez le fichier dans le dossier de votre choix.

## 1.3 Rappel des principes

Dans ce TP, nous allons r√©aliser des cartes avec **Observable JavaScript** (ou **ojs**). Rappelons que l'ojs est un ensemble d'am√©liorations apport√©es √† JavaScript avec l'objectif d'en faire un langage d√©di√© √† la visualisation de donn√©es pour le web. Ce langage est compl√®tement int√©gr√© dans Quarto.

Les caract√©ristiques de l'ojs sont les suivantes :

-   Il s'agit de JavaScript + des biblioth√®ques pr√©charg√©es comme `Plot` & `d3js` üìä
-   Tout est r√©actif üî• et rejou√© en temps r√©el
-   l'ordre des cellules n'a pas d'importance ü§Ø

Dans Quarto, toutes les instructions √† suivre s'√©crivent dans des chunks ojs

``` {{ojs}}
```

Pour chaque *chunck*, vous pouvez d√©finir avec `echo` si vous souhaitez que le code s'affiche ou non dans votre notebook final. Avec `eval`, vous choisissez si le code doit s'executer ou non.

``` {{ojs}}
//| echo: false
//| eval: true
```

Pour g√©n√©rer le document, il faut clicher sur le bouton `Render` ou tiliser le racourci clavier *Ctrl+Shift+K*.

## 1.4 Documentation et exemples

Au fil de ce notebook, vous pourrez vous r√©f√©rez √† des √©l√©ments de documentation en cliquant sur cet ic√¥ne.

![](img/logo_doc.png)

Vous pourrez √©galement acc√©der √† des exemples p√©dagogiques et des demos en ligne en cliquant sur celui-l√†.

![](img/logo_exemple.png)

# 2. Les donn√©es

Le jeu de donn√©es utilis√© concerne les pays africains. Nous avons un fond de carte contenant la g√©om√©trie des pays. Et un tableau de donn√©es issu du *Human Development Report 2020* et du *CEPII*, contenant diff√©rentes donn√©es statistiques, qualitatives ou quantitatives.

T√©l√©chargez les donn√©es et mettez-les dans un repertoire *data*.

<a href = "https://github.com/EE-CIST/CART3_cartodyn/raw/main/TP1/data/data.zip"><img src = "img/download.png" height= "50px"><img></a>

## 2.1 Import des donn√©es attributaires

Dans {ojs}, on importe les donn√©es avec l'instruction `FileAttachment()` <a href="https://github.com/observablehq/stdlib#file-attachments"><img src="img/logo_doc.png"/></a>

La fonction `.xlsx()` <a href="https://observablehq.com/@observablehq/xlsx"><img src="img/logo_exemple.png"/></a> permet d'importer des tableurs excel.

```{ojs}
classeur = FileAttachment("data/afrika.xlsx").xlsx()
```

`classeur.sheetNames` permet de voir la liste des feuilles contenues dans le classeur excel

```{ojs}
classeur.sheetNames
```

Visualisons les metadonn√©es avec `Inputs.table()` <a href="https://github.com/observablehq/inputs#inputstabledata-options"><img src="img/logo_doc.png"/></a>

```{ojs}
Inputs.table(classeur.sheet("meta", {headers:true}))
```

Et cr√©ons une variable `data` contenant les donn√©es de feuille data

```{ojs}
data = classeur.sheet("data", {headers:true})
```

Visualisons-la.

```{ojs}
Inputs.table(data)
```

## 2.2 Import des donn√©es g√©om√©triques

Import du fond de carte

```{ojs}
countries = FileAttachment("data/africa.json").json()
```

Le fond de carte est au format geoJSON

```{ojs}
countries
```

Pour la visualiser, on a besoin d'importer une biblioth√®que de cartographie. Ici, on choisit la biblioth√®que `bertin` <a href="https://github.com/neocarto/bertin"><img src="img/logo_doc.png"/></a> On l'importe grace √† l'instruction `require()`.

```{ojs}
bertin = require("bertin@1.5.10")
```

La fonction `quickdraw()` <a href="https://observablehq.com/@neocartocnrs/bertin-js-quickdraw-table2geo"><img src="img/logo_exemple.png"/></a> permet de visualiser rapidement n'importe quel fond de carte.

```{ojs}
bertin.quickdraw(countries, 500)
```

Pour r√©cup√©rer la table attributaire, on utilise l'instruction `bertin.properties.table()` <a href="https://github.com/neocarto/bertin#propertiestable"><img src="img/logo_doc.png"/></a>. Puis, on peut la visualiser sous forme de tableau avec `Inputs.table()`.

```{ojs}
Inputs.table(bertin.properties.table(countries))
```

# 2. Cr√©ation de carte statiques

## 2.1 Jointure

La premi√®re chose √† faire est de r√©aliser une jointure entre les donn√©es et le fond de carte. Pour cea on va proc√©der en 2 √©tapes. `bertin.match` <a href="https://github.com/neocarto/bertin#match"><img src="img/logo_doc.png"/></a> permet de tester et visaliser le compatibilit√© entre le fond de carte et le tableau de donn√©es. `bertin.merge` <a href="https://github.com/neocarto/bertin#merge"><img src="img/logo_doc.png"/></a> permet d'effectuer r√©ellement cette jointure. <a href="https://observablehq.com/@neocartocnrs/bertin-js-match-and-merge?collection=@neocartocnrs/bertin"><img src="img/logo_exemple.png"/></a>

```{ojs}
test = bertin.match(countries, "id", data, "iso3")
```

On constate que le jeu de donn√©es et le fond de carte sont compatibles √† 98%. Toutes les donn√©es disponibles dans le jeu de donn√©es peuvent √™tre jointe avec le fond de carte (49/49). Seule une unit√© g√©ographique dans le fond de carte n'a pas d'&quivalent dans le tableau de donn√©es (49/50). Pour savoir de quelle unit√© il s'agit, on peut taper `test.unmatched_geom`

```{ojs}
test.unmatched_geom
```

Il s'agit du Sahara Occidental. Il n'y a en effet pas de donn√©es pour cette unit√© g√©ographique. On peut donc d√©cider d'effecter la jointure pour de bon et de cr√©er un nouvel objet `africa`. Cet objet contient √† la fois les donn√©es et les g√©om√©tries.

```{ojs}
africa = bertin.merge(countries, "id", data, "iso3")
```

## 2.2 R√©aliser des cartes avec `bertin`

Pour r√©aliser une carte avec la biblioth√®que `bertin`, on utilise la fonction `draw()` <a href="https://github.com/neocarto/bertin#drawing-a-map"><img src="img/logo_doc.png"/></a>.

La fonction prend en entr√©e un objet avec la structure suivante <a href="https://observablehq.com/@neocartocnrs/hello-bertin-js?collection=@neocartocnrs/bertin"><img src="img/logo_exemple.png"/></a> :

![](img/bertin_code.png)

Ainsi, on peut √©crire :

```{ojs}
bertin.draw({
  params : {width : 500, background: "#CCC", margin: 20}, 
  layers :
    [
      {geojson: africa, fill: "#e07edd"},
      {type: "header", text: "Le continent africain"},
      {type: "scalebar"}
    ]
  })
```

Le type de carte th√©matique qu'on va r√©aliser d√©pend du type de donn√©es √† repr√©senter.

## 2.3. Cartographier des donn√©es quantitatives aboslues (stock)

En cartographie, on repr√©sente des donn√©es quantitatives absolues avec la variable visuelle TAILLE. Pour avoir des cercles proportionnels, dans `bertin`, on utilisera le type `bubble` <a href="https://github.com/neocarto/bertin#bubble"><img src="img/logo_doc.png"/></a><a href="https://observablehq.com/@neocartocnrs/bertin-js-prop-symbols?collection=@neocartocnrs/bertin"><img src="img/logo_exemple.png"/></a>

```{ojs}
bertin.draw({
  params : {width : 500, background: "#CCC", margin: 20}, 
  layers :
    [
      {
        type : "bubble", 
        geojson: africa,
        values: "POP",
        k: 50, // rayon du plus grand cercle
        fill: "red",
        leg_x: 30,
        leg_y: 300,
        leg_round: 0,
        leg_title: "Nombre d'habitants"
      },
      {geojson: africa, fill: "#DDD"},
      {type: "header", text: "Le continent africain"},
      {type: "scalebar"}
    ]
  })
```

D'autres modes de repr√©sentation auraient bien s√ªr √©t√© possibles. On aurait √©galement pu faire des carr√©s <a href="https://observablehq.com/@neocartocnrs/bertin-js-prop-squares?collection=@neocartocnrs/bertin"><img src="img/logo_exemple.png"/></a> ou des *spikes* <a href="https://observablehq.com/@neocartocnrs/bertin-js-spikes?collection=@neocartocnrs/bertin"><img src="img/logo_exemple.png"/></a>

## 2.4 Cartographier des donn√©es qualitatives nominales

Il y a plusieurs fa√ßons de cartographier des donn√©es qualitatives nominales. Sur √©cran, en cartographie num√©rique, on choisra la plupart du temps la variable visuelle COULEUR (teinte).

Dans `bertin`, il s'agit donc de faire varier la propri√©t√© `fill` et de la faire varier en fonction d'une donn√©e qualitative. Pour cela, on utilise le type `typo` <a href="https://github.com/neocarto/bertin#typology"><img src="img/logo_doc.png"/></a><a href="https://observablehq.com/@neocartocnrs/bertin-js-typo?collection=@neocartocnrs/bertin"><img src="img/logo_exemple.png"/></a>.

```{ojs}
bertin.draw({
  params : {width : 500, background: "#CCC", margin: 20}, 
  layers :
    [
      {
        geojson: africa, 
        fill: {
                type : "typo",
                values: "SUBREG",
                leg_x: 30,
                leg_y: 330,
                leg_title: "Sub regions",
                txt_missing: "Pas de donn√©es",
                pal: "Tableau10",
              }
      },
      {type: "header", text: "Le continent africain"},
    ]
  })
```

La palette de couleurs oar d√©faut est `Tableau10`. Mais il est possible d'en choisir une autre : `Category10`, `Accent`, `Dark2`, `Paired`, `Pastel1`, `Pastel2`, `Set1`, `Set2` ou `Set3` <a href="https://observablehq.com/@d3/color-schemes"><img src="img/logo_exemple.png"/></a>.

Il est aussi possible de d√©finir vos propres couleurs en repla√ßant `pal: "Tableau10"` par `colors: ["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3"]`.

## 2.5 Cartographier des donn√©es quantitatives relatives (ratio, indice)

Il y a plusieurs fa√ßons de cartographier des donn√©es quantitatives relatives. Sur √©cran, en cartographie num√©rique, on choisra la plupart du temps de r√©aliser une carte choropl√®the avec des couleurs ordonn√©es. Un √©tape de discr√©tisation pr√©alable est n√©c√©ssaire. Elle n√©cessite d'√©tudier la forme de la distribution statistique. Pour cel√†, on utilisera la librairie `Plot` <a href="https://github.com/observablehq/plot"><img src="img/logo_doc.png"/></a> <a href="https://observablehq.com/collection/@observablehq/plot"><img src="img/logo_exemple.png"/></a> disponible nativement dans les celles `{ojs}`.

Il y a plusieurs fa√ßons de visualister la forme d'une distribution <a href="https://observablehq.com/@cartographie/les-discretisations?collection=@cartographie/cours"><img src="img/logo_exemple.png"/></a> Ici, on choisira un graphique avec des points et une transformation de type dodge.

```{ojs}
Plot.plot({
  height: 60,
  marks: [
    Plot.dotX(
      data,
      Plot.dodgeY({ x: "IDH", fill: "red" })
    )
  ]
})
```

Dans `bertin`, il s'agit donc de faire varier comme pr√©c√©demment la propri√©t√© `fill`. Pour cela, on utilise le type `choro` <a href="https://github.com/neocarto/bertin#choropleth"><img src="img/logo_doc.png"/></a> <a href="https://observablehq.com/@neocartocnrs/bertin-js-chropoleth?collection=@neocartocnrs/bertin"><img src="img/logo_exemple.png"/></a>

Les m√©thodes de discr√©tisation disponibles son celles contenues dans la libraire `statsbreaks` <a href="https://observablehq.com/@neocartocnrs/hello-statsbreaks"><img src="img/logo_exemple.png"/></a> : `quantile`, `q6`, `jenks`, `msd` (moyenne √©cart-type) et `equal`. Pour les couleurs, de nombreuses palettes sont disponibles : `Blues`, `Greens`, `Greys`, `Oranges`, `Purples`, `Reds`, `BrBG`, `PRGn`, `PiYG`, `PuOr`, `RdBu`, `RdYlBu`, `RdYlGn`, `Spectral`,`Turbo`,`Viridis`,`Inferno`, `Magma`, `Plasma`, `Cividis`, `Warm`, `Cool`, `CubehelixDefault`, `BuGn`, `BuPu`, `GnBu`, `OrRd`, `PuBuGn`, `PuBu`, `PuRd`, `RdPu`, `YlGnBu`, `YlGn`, `YlOrBr`, `YlOrRd`, `Rainbow`, `Sinebow` <a href="https://observablehq.com/@d3/color-schemes"><img src="img/logo_exemple.png"/></a>

Par d√©faut, la m√©thode choisie est le `quantile`, la palettes est `Blues` et le nombre de classes est √©gal √† 5.

```{ojs}
bertin.draw({
  params : {width : 500, background: "#CCC", margin: 20}, 
  layers :
    [
      {
        geojson: africa, 
        fill: {
                type : "choro",
                values: "IDH",
                leg_x: 30, // position de la l√©gende en x
                leg_y: 330, // position de la l√©gende en y
                leg_round: 2, // 2 chiffres apr√®s la virgule
                leg_title: "IDH",
                txt_missing: "Pas de donn√©es",
                method: "quantile",
                nbreaks: 4,
                colors: "OrRd"
              }
      },
      {type: "header", text: "Indicateur de d√©veloppement humain"},
    ]
  })
```

# 3. Faire une carte interactive (1/2)

Avec Observable JavaScript, nous sommes dans un √©cosyst√®me pleinement r√©actif üî• Cela signifie qu'il est possible de proposer √† l'utilisateur des possibilit√©s d'interaction avec la carte. Reprenons le cade de la carte par symboles proportionnels... et personnalisons le un peu en rempla√ßant les valeurs √©crites *en dur* par des valeurs issues des `Inputs` <a href="https://github.com/observablehq/inputs"><img src="img/logo_doc.png"/></a> <a href="https://observablehq.com/@observablehq/inputs"><img src="img/logo_exemple.png"/></a>

Il est √©galement possible d'ajouter des infobulles <a href="https://observablehq.com/@neocartocnrs/bertin-js-tooltips?collection=@neocartocnrs/bertin"><img src="img/logo_exemple.png"/></a>

```{ojs}
viewof k = Inputs.range([10, 75], { label: "Taille", step: 1, value: 40 })
viewof symbol = Inputs.radio(["bubble", "square", "spikes"], { label: "Symbole", value: "bubble" })
viewof color = Inputs.color({label: "Couleur", value: "#CC0000"})
viewof toggle = Inputs.toggle({label: "Ecarter les symboles", value: false})

bertin.draw({
  params : {width : 500, background: "#CCC", margin: 20}, 
  layers :
    [
      {
        type : symbol, 
        geojson: africa,
        values: "POP",
        k: k, // rayon du plus grand cercle
        fill: color,
        stroke: "white",
        dorling: toggle,
        leg_x: 30,
        leg_y: 300,
        leg_round: 0,
        leg_title: "Nombre d'habitants\n(en millions)",
        //tooltip: ["$name", "$POP"]
        tooltip: ["$name", d => Math.round(d.properties.POP) + " millions d'habitants"]        
      },
      {geojson: africa, fill: "#DDD"},
      {type: "header", text: "Le continent africain"},
      {type: "scalebar"}
    ]
  })
```

# Faire une carte interactive (2/2)

Ici, on ne souhaite plus voir "flotter" l'Afrique. Donc, on importe un nouveau fichier contenant les pays du Monde. Cette couche servira √† l'habillage. Dans les param√®tres g√©n√©raux de la carte, il faudra bien penser √† d√©finir l'`extent` pour que la carte ne s'affiche pas √† l'√©chelle mondiale.

```{ojs}
world = FileAttachment("data/world.json").json()
```

De plus, pour am√©liorer la carte pr√©c√©dente, on rajoute quelques couches d'habillage comme `shadow`<a href="https://github.com/neocarto/bertin#shadow"><img src="img/logo_doc.png"/></a> et `hatch` <a href="https://github.com/neocarto/bertin#hatch-or-hatching"><img src="img/logo_doc.png"/></a>


Puis, pour faire varier la carte pr√©c√©dente, on choisi de repr√©senter les donn√©es avec le type `dotcartogram` qui d√©compose chaque cercke en un nombre de points de m√™me valeurs, plac√©s sur le centroid <a href="https://github.com/neocarto/bertin#dot-cartogram"><img src="img/logo_doc.png"/></a><a href="https://observablehq.com/@neocartocnrs/bertin-js-dots-cartograms?collection=@neocartocnrs/bertin"><img src="img/logo_exemple.png"/></a>. Le reste s'√©crit grosso modo comme la carte pr√©c√©dente.


```{ojs}
viewof radius = Inputs.range([1, 10], { label: "Rayon", step: 0.5 })
viewof onedot = Inputs.range([1, 20], {
  label: "Valeur du point (en millions)",
  step: 1,
  value: 10
})

bertin.draw({
  params : {width : 500, background: "#8ddaf0", margin: 20, extent: africa}, 
  layers :
    [
      {type: "header", text: "Le continent africain"},
      {
        type : "dotcartogram", 
        geojson: africa,
        values: "POP",
        radius: radius, 
        onedot: onedot,
        fill: color,
        stroke: "white",
        dorling: toggle,
        leg_x: 30,
        leg_y: 300,
        leg_round: 0,
        leg_title: "Nombre d'habitants\n(en millions)",
        //tooltip: ["$name", "$POP"]
        tooltip: ["$name", d => Math.round(d.properties.POP) + " millions d'habitants"]        
      },
      {geojson: africa, fill: "#DDD"},
      {type:"shadow", geojson:africa},
      {geojson:world, fill:"white", fillOpacity:0.5, stroke: "none"},
      {type:"hatch"},
      {type: "scalebar"}
    ]
  })
```


# √Ä vous de jouer

<br/>

::: up2u
Choisissez une donn√©e quantitative relative √† cartographier dans la liste suivante (sauf l'idh):

```{ojs}
//| echo: false
//| eval: true
Inputs.table(classeur.sheet("meta", {headers:true, columns : ["Code", "D√©finition"]}))
```

R√©alisez une carte chorop√®the avec `bertin` en faisant varier :

-   la palette de couleurs via une liste d√©roulante <a href="https://observablehq.com/@observablehq/input-select?collection=@observablehq/inputs"><img src="img/logo_exemple.png"/></a>
-   le nombre de classes via un slider <a href="https://observablehq.com/@observablehq/input-range?collection=@observablehq/inputs"><img src="img/logo_exemple.png"/></a>
:::

<br/>

*NB : N'oubliez pas d'analyser la distribution statistique pour choisir la bonne m√©thode de discr√©tisation.*
